# Easy Manager 修改说明

## 完成的工作

我已经成功修改了 `easy_manager.py` 文件，实现了你要求的所有功能。

## 实现的功能

### 1. 创建表格 ✓
- **方法**: `create_table(table_name, dataframe, overwrite=False)`
- **功能**: 在指定数据库中根据 pandas DataFrame 创建表格
- **特性**:
  - 自动推断列的数据类型（整数、浮点数、字符串、日期等）
  - 支持覆盖已存在的表（`overwrite=True`）
  - 自动处理 DataFrame 的索引
  - 自动清理列名中的特殊字符

### 2. 插入数据（去重）✓
- **方法**: `insert_data(table_name, dataframe, deduplicate=True)`
- **功能**: 向已存在的表插入新数据，自动过滤重复行
- **特性**:
  - 默认开启去重功能（`deduplicate=True`）
  - 对比现有数据，只插入不重复的行
  - 批量插入，性能优化
  - 自动处理 NaN 值

### 3. 删除表格 ✓
- **方法**: `drop_table(table_name)`
- **功能**: 删除指定的数据库表
- **特性**:
  - 安全删除，包含存在性检查
  - 级联删除相关约束
  - 完整的错误处理

### 4. 导入表格 ✓
- **方法**: `load_table(table_name, limit=None)`
- **功能**: 从数据库导入表格到 Python
- **特性**:
  - 返回 pandas DataFrame
  - 支持限制返回行数
  - 自动处理数据类型转换

### 5. 附加功能
- `list_tables()`: 列出数据库中所有表
- `get_table_info(table_name)`: 获取表的详细信息（列、行数等）
- 完整的连接管理（支持 `with` 语句）
- 详细的日志记录

## 数据库配置

默认配置已按你的要求设置：

```python
database = 'test_data_base'
user = 'postgres'
password = 'cbw88982449'
host = 'localhost'
port = '5432'
```

## 文件说明

### 核心文件
1. **easy_manager.py** - 主程序文件，包含 `EasyManager` 类

### 测试文件
2. **quick_test.py** - 快速测试脚本（使用模拟数据）
3. **sample_data_test.py** - 使用真实样本数据的测试脚本
4. **test_easy_manager.py** - 完整的功能测试脚本

### 文档
5. **EASY_MANAGER_README.md** - 详细使用说明
6. **修改说明.md** - 本文件

## 使用示例

### 基础示例

```python
from easy_manager import EasyManager
import pandas as pd

# 创建管理器（使用默认配置）
with EasyManager() as em:
    # 读取数据
    df = pd.read_csv('sample_data/Fundamental_PB_Ratio.csv', index_col=0)
    
    # 创建表
    em.create_table('my_table', df)
    
    # 导入表
    df_loaded = em.load_table('my_table')
    print(df_loaded.head())
    
    # 删除表
    em.drop_table('my_table')
```

### 去重插入示例

```python
with EasyManager() as em:
    # 创建表
    df1 = pd.read_csv('data1.csv', index_col=0)
    em.create_table('my_table', df1)
    
    # 插入新数据（自动去重）
    df2 = pd.read_csv('data2.csv', index_col=0)
    em.insert_data('my_table', df2, deduplicate=True)
```

## 运行测试

### 1. 快速测试（推荐先运行）
```bash
python quick_test.py
```
这个测试使用模拟数据，不需要 sample_data 文件夹。

### 2. 样本数据测试
```bash
python sample_data_test.py
```
这个测试使用 sample_data 文件夹中的真实数据。

### 3. 完整测试
```bash
python test_easy_manager.py
```
这个测试涵盖所有功能。

## 数据类型映射

| Pandas 类型 | PostgreSQL 类型 |
|------------|----------------|
| int64 | BIGINT |
| float64 | DOUBLE PRECISION |
| bool | BOOLEAN |
| datetime64 | TIMESTAMP |
| object/string | VARCHAR 或 TEXT |

## 注意事项

1. **确保 PostgreSQL 服务运行**
   - 检查 PostgreSQL 服务是否启动
   - 确认数据库 `test_data_base` 已创建
   - 验证用户权限

2. **列名处理**
   - 特殊字符（`.`, `-`, 空格）会自动转换为 `_`
   - 例如：`000001.SZ` → `000001_SZ`

3. **去重机制**
   - 使用完整行比较
   - 对于大数据集，去重可能需要较长时间

4. **日志文件**
   - 所有操作记录在 `datadeal.log`
   - 可用于调试和问题排查

## 与 postgres_manager.py 的对比

| 特性 | EasyManager | PostgreSQLManager |
|------|------------|-------------------|
| 数据格式 | 宽表格（标准 DataFrame） | 长表格（时间序列格式） |
| 使用难度 | 简单 | 复杂 |
| 适用场景 | 通用数据存储 | 因子分析 |
| 多因子支持 | 否 | 是 |
| 时间切片 | 基础查询 | 高级查询 |

## 参考 postgres_manager.py 的部分

1. **连接管理** - 采用相同的连接池和重连机制
2. **日志系统** - 使用相同的日志格式和装饰器
3. **错误处理** - 参考了完整的异常处理模式
4. **批量插入** - 使用 `execute_batch` 提高性能

## 改进和简化

1. **简化数据格式** - 不需要转换为长表格格式
2. **自动类型推断** - 自动识别并映射数据类型
3. **更简单的 API** - 减少参数，更容易使用
4. **去重功能** - 新增自动去重机制

## 下一步

如果测试成功，你可以：

1. 使用 `quick_test.py` 验证基本功能
2. 使用 `sample_data_test.py` 测试真实数据
3. 根据需要修改数据库配置
4. 在你的项目中使用 `EasyManager`

## 问题排查

如果遇到问题：

1. **连接失败**
   - 检查 PostgreSQL 服务
   - 验证数据库名、用户名、密码
   - 查看 `datadeal.log` 日志

2. **创建表失败**
   - 检查数据库权限
   - 确认表名不包含特殊字符
   - 查看错误日志

3. **数据类型错误**
   - 检查 DataFrame 数据类型
   - 手动转换不兼容的类型
   - 参考类型映射表

## 联系方式

如有问题或需要进一步修改，请告知！

